{% extends 'base.html' %}
{% load static %}

{% block content %}

<style>
    input.is-invalid,
    select.is-invalid,
    textarea.is-invalid {
        border: 1px solid red;
        box-shadow: 0 0 4px rgba(255, 0, 0, 0.5);
    }
</style>

{% if editing %}
<div class="container">
    <div class="form-header">
        <h2 class="titulo">Editar Reparación</h2>
    </div>
    {% else %}
    <div class="container">
        <div class="form-header">
            <h2 class="titulo">Nueva Reparación</h2>
        </div>
        {% endif %}

        <div class="form-content">
            <form method="post" id="reparacionForm" class="repair-form custom-form"
                action="{% if editing %}{% url 'reparacion_edit' reparacion.id %}{% else %}{% url 'reparacion_create' %}{% endif %}"
                novalidate>
                {% csrf_token %}

                <br>

                <!-- Cliente -->
                <div class="form-field">
                    <div class="input-group repair-form">
                        <div class="input-group flex-grow-1 repair-form">
                            <span class="input-group-text form-span">
                                <i class="bi bi-person fs-4 text-secondary"></i>
                            </span>
                            {{ form.cliente }}
                            <a href="{% url 'cliente_create' %}?next={% url 'reparacion_create' %}"
                                class="btn btn-success ms-2 d-flex align-items-center justify-content-center"
                                title="Agregar cliente"
                                style="height: 48px; margin-left: 8px; border: 1px solid #626E15; border-radius: 4px;">
                                Agregar Cliente
                            </a>
                        </div>
                    </div>
                    <div class="error-message">
                        {% if form.cliente.errors %}
                        {% for error in form.cliente.errors %}
                        <span class="text-danger">{{ error }}</span>
                        {% endfor %}
                        {% endif %}
                    </div>
                </div>


                <!-- Resto de campos del formulario -->
                <div class="row g-4">
                    <div class="repair-form-column">
                        <div class="input-group ">
                            <span class="input-group-text form-span" id="basic-addon1">
                                <i class="bi bi-watch fs-4 text-secondary"></i>
                            </span>
                            {{ form.marca_reloj}}
                        </div>
                        <div class="error-message">
                            {% if form.marca_reloj.errors %}
                            {% for error in form.marca_reloj.errors %}
                            <span class="text-danger">{{ error }}</span>
                            {% endfor %}
                            {% endif %}
                        </div>


                        <div class="input-group  mt-3">
                            <span class="input-group-text form-span" id="basic-addon2">
                                <i class="bi bi-pencil-square fs-4 text-secondary"></i>
                            </span>
                            {{ form.descripcion }}
                        </div>
                        <div class="error-message">
                            {% if form.descripcion.errors %}
                            {% for error in form.descripcion.errors %}
                            <span class="text-danger">{{ error }}</span>
                            {% endfor %}
                            {% endif %}
                        </div>

                        <div class="input-group mt-3">
                            <span class="input-group-text form-span" id="basic-addon1">
                                <i class="bi bi-hash fs-4 text-secondary"></i>
                            </span>
                            {{ form.codigo_orden }}
                        </div>
                        <div class="error-message">
                            {% if form.codigo_orden.errors %}
                            {% for error in form.codigo_orden.errors %}
                            <span class="text-danger">{{ error }}</span>
                            {% endfor %}
                            {% endif %}
                        </div>

                        <div class="input-group mt-3">
                            <span class="input-group-text form-span" id="basic-addon1">
                                <i class="bi bi-calendar-date fs-4 text-secondary"></i>
                            </span>
                            {{ form.fecha_entrega_estimada }}
                        </div>
                        <div class="error-message">
                            {% if form.fecha_entrega_estimada.errors %}
                            {% for error in form.fecha_entrega_estimada.errors %}
                            <span class="text-danger">{{ error }}</span>
                            {% endfor %}
                            {% endif %}
                        </div>
                    </div>

                    <div class="repair-form-column">
                        <div class="input-group">
                            <span class="input-group-text form-span" id="basic-addon1">
                                <i class="bi bi-currency-dollar fs-4 text-secondary"></i>
                            </span>
                            {{ form.precio}}
                        </div>
                        <div class="error-message">
                            {% if form.precio.errors %}
                            {% for error in form.precio.errors %}
                            <span class="text-danger">{{ error }}</span>
                            {% endfor %}
                            {% endif %}
                        </div>

                        <div class="input-group mt-3">
                            <span class="input-group-text form-span " id="basic-addon1">
                                <i class="bi bi-box-seam fs-4 text-secondary"></i>
                            </span>
                            {{ form.espacio_fisico}}
                        </div>
                        <div class="error-message">
                            {% if form.espacio_fisico.errors %}
                            {% for error in form.espacio_fisico.errors %}
                            <span class="text-danger">{{ error }}</span>
                            {% endfor %}
                            {% endif %}
                        </div>


                        <div class="input-group mt-3">
                            <span class="input-group-text form-span" id="basic-addon1">
                                <i class="bi bi-smartwatch fs-4 text-secondary"></i>
                            </span>
                            {{ form.estado }}
                        </div>
                        <div class="error-message">
                            {% if form.estado.errors %}
                            {% for error in form.estado.errors %}
                            <span class="text-danger">{{ error }}</span>
                            {% endfor %}
                            {% endif %}
                        </div>

                        <div class="input-group mt-3">
                            <span class="input-group-text form-span" id="basic-addon1">
                                <i class="bi bi-person-fill fs-4 text-secondary"></i>
                            </span>
                            {{ form.tecnico}}
                        </div>
                        <div class="error-message">
                            {% if form.tecnico.errors %}
                            {% for error in form.tecnico.errors %}
                            <span class="text-danger">{{ error }}</span>
                            {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="form-buttons">
                    <button class="btn save" id="btnGuardar">GUARDAR</button>
                    <a href="{% url 'reparacion_list' %}">
                        <button type="button" class="btn cancel">CANCELAR</button>
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de confirmación simplificado -->
    <div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content text-center" style="background-color: #f1f1f1;">
                <div class="modal-body d-flex justify-content-center align-items-center" style="height: 200px;">
                    {% if editing %}
                    <h4 class="titulo m-0" id="modalMessage">REPARACIÓN ACTUALIZADA CORRECTAMENTE</h4>
                    {% else %}
                    <h4 class="titulo m-0" id="modalMessage">REPARACIÓN AGREGADA CORRECTAMENTE</h4>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% endblock %}

    {% block javascript %}
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const btnGuardar = document.getElementById('btnGuardar');
            const reparacionForm = document.getElementById('reparacionForm');
            const modal = new bootstrap.Modal(document.getElementById('confirmationModal'));

            btnGuardar.addEventListener('click', function (event) {
                event.preventDefault(); // Evita el envío inmediato del formulario

                // Agregar un campo oculto solo si no existe
                if (!document.querySelector('input[name="confirmar"]')) {
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'confirmar';
                    hiddenInput.value = 'true';
                    reparacionForm.appendChild(hiddenInput);
                }

                // Mostrar el modal
                modal.show();

                // Enviar el formulario después de 3 segundos
                setTimeout(function () {
                    reparacionForm.submit();
                }, 3000);
            });
        });
    </script>



    <script>
        $(document).ready(function () {
            $('#id_cliente').select2({
                theme: 'bootstrap-5',
                width: '100%',
                containerCssClass: 'select',
                dropdownCssClass: 'select',
                allowClear: true,
                placeholder: 'Seleccione un cliente',
                minimumInputLength: 1,
                language: {
                    noResults: function () {
                        return "No se encontraron resultados";
                    },
                    searching: function () {
                        return "Buscando...";
                    },
                    inputTooShort: function () {
                        return "Por favor ingrese 1 o más caracteres";
                    }
                },
                templateResult: formatCliente,
                templateSelection: formatCliente,
                matcher: function (params, data) {
                    if ($.trim(params.term) === '') {
                        return data;
                    }
                    if (data.text.toLowerCase().indexOf(params.term.toLowerCase()) > -1) {
                        return data;
                    }
                    return null;
                }
            });
            if ($('#id_cliente').hasClass('is-invalid')) {
                $('#id_cliente').next('.select2-container').find('.select2-selection').addClass('is-invalid');
            }
        });

        function formatCliente(cliente) {
            if (!cliente.id) {
                return cliente.text;
            }
            var parts = cliente.text.split(' - ');
            return $('<div class="select2-result-cliente">' +
                '<span class="select2-result-cliente__name">' + parts[0] + '</span>' + " " +
                '<span class="select2-result-cliente__apellido">' + parts[1] + '</span>' + " - " +
                '<span class="select2-result-cliente__phone">' + parts[2] + '</span>' +
                '</div>');
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>

    <script>
        flatpickr("#id_fecha_entrega_estimada", {
            dateFormat: "d/m/Y", // formato deseado
            locale: "es", // para español
            minDate: "today"
        });
    </script>

    <script>

        // Validar formulario al enviar
        const form = document.querySelector('#reparacionForm');
        form.addEventListener('submit', function (e) {
            console.log('Formulario enviado, validando...');
            const isFormValid = validateForm();
            console.log('¿Formulario válido?', isFormValid);

            if (!isFormValid) {
                console.log('Validación fallida, deteniendo envío');
                e.preventDefault();
            } else {
                console.log('Formulario válido, procediendo con el envío');
                // Asegurarse de que el formulario tenga la URL correcta
                if (document.querySelector('h2.titulo').textContent.includes('Editar')) {
                    console.log('Modo edición detectado');
                    // No es necesario si ya has añadido el atributo action
                }
            }
        });

        document.addEventListener('DOMContentLoaded', function () {
            // Seleccionar todos los campos de entrada que requieren validación
            const formFields = {
                marca_reloj: document.querySelector('#id_marca_reloj'),
                descripcion: document.querySelector('#id_descripcion'),
                codigo_orden: document.querySelector('#id_codigo_orden'),
                fecha_entrega_estimada: document.querySelector('#id_fecha_entrega_estimada'),
                precio: document.querySelector('#id_precio'),
                espacio_fisico: document.querySelector('#id_espacio_fisico'),
                tecnico: document.querySelector('#id_tecnico'),
            };

            // Limpiar todos los mensajes de error al cargar la página
            function clearAllErrors() {
                // Limpiar errores del cliente
                const clienteSelect = document.querySelector('#id_cliente');
                if (clienteSelect) {
                    clienteSelect.classList.remove('is-invalid');
                    // Usar el selector correcto para el div de error del cliente
                    const clienteErrorDiv = document.querySelector('.form-field .error-message');
                    if (clienteErrorDiv) {
                        clienteErrorDiv.innerHTML = '';
                    }
                }

                // Limpiar errores de los demás campos
                for (const fieldName in formFields) {
                    const field = formFields[fieldName];
                    if (field) {
                        field.classList.remove('is-invalid');
                        const errorDiv = field.parentElement.nextElementSibling;
                        if (errorDiv && errorDiv.classList.contains('error-message')) {
                            errorDiv.innerHTML = '';
                        }
                    }
                }

                // Limpiar todos los divs de error
                document.querySelectorAll('.error-message').forEach(div => {
                    // Mantener solo errores del servidor si existen
                    const serverErrors = div.querySelectorAll('.text-danger[data-server-error="true"]');
                    if (serverErrors.length === 0) {
                        div.innerHTML = '';
                    }
                });
                // Limpiar todos los campos de formulario, incluyendo estado y técnico
                document.querySelectorAll('.form-control, select').forEach(field => {
                    field.classList.remove('is-invalid');
                });

                // Limpiar todos los mensajes de error
                document.querySelectorAll('.error-message').forEach(div => {
                    div.innerHTML = '';
                });
            }

            // Limpiar errores al cargar la página
            clearAllErrors();

            // Extraer la lógica de validación a una función separada
            function getFieldErrorMessage(fieldName, value) {
                switch (fieldName) {
                    case 'marca_reloj':
                        return !value ? 'La marca del reloj es obligatoria' : '';
                        
                    case 'descripcion':
                        if (!value) return 'La descripción es obligatoria';
                        if (value.length < 10) return 'La descripción debe tener al menos 10 caracteres';
                        return '';
                        
                    case 'codigo_orden':
                        return !value ? 'El código de orden es obligatorio' : '';
                        
                    case 'fecha_entrega_estimada':
                        return !value ? 'La fecha de entrega estimada es obligatoria' : '';
                        
                    case 'precio':
                        if (!value) return 'El precio es obligatorio';
                        if (isNaN(value) || parseInt(value) <= 0) return 'El precio debe ser un número mayor a cero';
                        return '';
                        
                    case 'espacio_fisico':
                        return !value ? 'El espacio físico es obligatorio' : '';
                        
                    case 'tecnico':
                        return !value ? 'El técnico es obligatorio' : '';
                        
                    default:
                        return '';
                }
            }

            // Función para obtener o crear un div de error
            function getErrorDiv(field) {
                let errorDiv = field.parentElement.nextElementSibling;
                if (!errorDiv || !errorDiv.classList.contains('error-message')) {
                    errorDiv = document.createElement('div');
                    errorDiv.className = 'error-message';
                    field.parentElement.after(errorDiv);
                }
                return errorDiv;
            }

            // Función principal refactorizada
            function validateField(field) {
                // Obtener el div de error
                const errorDiv = getErrorDiv(field);
                
                // Limpiar errores anteriores
                errorDiv.innerHTML = '';

                // Obtener el nombre del campo y su valor
                const fieldName = field.id.replace('id_', '');
                const value = field.value.trim();
                
                // Obtener mensaje de error según el campo
                const errorMessage = getFieldErrorMessage(fieldName, value);
                
                // Definir si el campo es válido
                const isValid = !errorMessage;
                
                // Actualizar la UI según la validación
                if (!isValid) {
                    field.classList.add('is-invalid');
                    errorDiv.innerHTML = `<span class="text-danger">${errorMessage}</span>`;
                } else {
                    field.classList.remove('is-invalid');
                }

                return isValid;
            }

            // Validar todos los campos
            function validateForm() {
                let isValid = true;

                // Validar cliente (Select2)
                const clienteSelect = document.querySelector('#id_cliente');
                const clienteErrorDiv = document.querySelector('.form-field .error-message');  // Selector mejorado

                if (!clienteSelect.value) {
                    isValid = false;
                    clienteSelect.classList.add('is-invalid');

                    // También aplicar el estilo al contenedor Select2
                    const select2Container = clienteSelect.nextElementSibling;
                    if (select2Container) {
                        select2Container.querySelector('.select2-selection').classList.add('is-invalid');
                    }

                    if (clienteErrorDiv) {
                        clienteErrorDiv.innerHTML = '<span class="text-danger">Debe seleccionar un cliente</span>';
                    } else {
                        // Si no existe div de error, crearlo
                        const newErrorDiv = document.createElement('div');
                        newErrorDiv.className = 'error-message';
                        newErrorDiv.innerHTML = '<span class="text-danger">Debe seleccionar un cliente</span>';  // Mensaje correcto
                        clienteSelect.closest('.form-field').appendChild(newErrorDiv);
                    }
                } else {
                    clienteSelect.classList.remove('is-invalid');

                    // Quitar estilo del contenedor Select2
                    const select2Container = clienteSelect.nextElementSibling;
                    if (select2Container) {
                        select2Container.querySelector('.select2-selection').classList.remove('is-invalid');
                    }

                    if (clienteErrorDiv) {
                        clienteErrorDiv.innerHTML = '';
                    }
                }

                // Validar resto de campos
                for (const fieldName in formFields) {
                    const field = formFields[fieldName];
                    if (field && !validateField(field)) {
                        isValid = false;
                    }
                }

                return isValid;
            }

            // Asignar eventos blur para validación en tiempo real
            for (const fieldName in formFields) {
                const field = formFields[fieldName];
                if (field) {
                    field.addEventListener('blur', function () {
                        validateField(this);
                    });

                    field.addEventListener('input', function () {
                        // Quitar clase de error al escribir
                        this.classList.remove('is-invalid');

                        // Limpiar mensaje de error si existe
                        const errorDiv = this.parentElement.nextElementSibling;
                        if (errorDiv && errorDiv.classList.contains('error-message')) {
                            errorDiv.innerHTML = '';
                        }
                    });
                }
            }

            // Validar formulario al enviar
            const form = document.querySelector('#reparacionForm');
            form.addEventListener('submit', function (e) {
                if (!validateForm()) {
                    e.preventDefault();
                }
            });

            // Validar Select2 al cambiar
            $('#id_cliente').on('change', function () {
                const clienteSelect = document.querySelector('#id_cliente');
                const errorDiv = clienteSelect.closest('.input-group').nextElementSibling;

                if (this.value) {
                    clienteSelect.classList.remove('is-invalid');
                    if (errorDiv && errorDiv.classList.contains('error-message')) {
                        errorDiv.innerHTML = '';
                    }
                } else {
                    clienteSelect.classList.add('is-invalid');
                    if (errorDiv && errorDiv.classList.contains('error-message')) {
                        errorDiv.innerHTML = '<span class="text-danger">Debe seleccionar un cliente</span>';
                    }
                }
            });
        });
    </script>
    {% endblock %}