{% extends 'base.html' %}
{% load static %}

{% block content %}

<style>
    input.is-invalid,
    select.is-invalid,
    textarea.is-invalid {
        border: 1px solid red;
        box-shadow: 0 0 4px rgba(255, 0, 0, 0.5);
    }
</style>

{% if editing %}
<div class="container">
    <div class="form-header">
        <h2 class="titulo">Editar Reparación</h2>
    </div>
    {% else %}
    <div class="container">
        <div class="form-header">
            <h2 class="titulo">Nueva Reparación</h2>
        </div>
        {% endif %}

        <div class="form-content">
            <form method="post" id="reparacionForm" class="repair-form custom-form"
                action="{% if editing %}{% url 'reparacion_edit' reparacion.id %}{% else %}{% url 'reparacion_create' %}{% endif %}"
                novalidate>
                {% csrf_token %}

                <br>

                <!-- Cliente -->
                <div class="form-field">
                    <div class="input-group repair-form">
                        <div class="input-group flex-grow-1 repair-form">
                            <span class="input-group-text form-span">
                                <i class="bi bi-person fs-4 text-secondary"></i>
                            </span>
                            {{ form.cliente }}
                            <a href="{% url 'cliente_create' %}?next={% url 'reparacion_create' %}"
                                class="btn btn-success ms-2 d-flex align-items-center justify-content-center"
                                title="Agregar cliente"
                                style="height: 48px; margin-left: 8px; border: 1px solid #626E15; border-radius: 4px;">
                                Agregar Cliente
                            </a>
                        </div>
                    </div>
                    <div class="error-message">
                        {% if form.cliente.errors %}
                        {% for error in form.cliente.errors %}
                        <span class="text-danger">{{ error }}</span>
                        {% endfor %}
                        {% endif %}
                    </div>
                </div>


                <!-- Resto de campos del formulario -->
                <div class="row g-4">
                    <div class="repair-form-column">
                        <div class="input-group ">
                            <span class="input-group-text form-span" id="basic-addon1">
                                <i class="bi bi-watch fs-4 text-secondary"></i>
                            </span>
                            {{ form.marca_reloj}}
                        </div>
                        <div class="error-message">
                            {% if form.marca_reloj.errors %}
                            {% for error in form.marca_reloj.errors %}
                            <span class="text-danger">{{ error }}</span>
                            {% endfor %}
                            {% endif %}
                        </div>


                        <div class="input-group  mt-3">
                            <span class="input-group-text form-span" id="basic-addon2">
                                <i class="bi bi-pencil-square fs-4 text-secondary"></i>
                            </span>
                            {{ form.descripcion }}
                        </div>
                        <div class="error-message">
                            {% if form.descripcion.errors %}
                            {% for error in form.descripcion.errors %}
                            <span class="text-danger">{{ error }}</span>
                            {% endfor %}
                            {% endif %}
                        </div>

                        <div class="input-group mt-3">
                            <span class="input-group-text form-span" id="basic-addon1">
                                <i class="bi bi-hash fs-4 text-secondary"></i>
                            </span>
                            {{ form.codigo_orden }}
                        </div>
                        <div class="error-message">
                            {% if form.codigo_orden.errors %}
                            {% for error in form.codigo_orden.errors %}
                            <span class="text-danger">{{ error }}</span>
                            {% endfor %}
                            {% endif %}
                        </div>

                        <div class="input-group mt-3">
                            <span class="input-group-text form-span" id="basic-addon1">
                                <i class="bi bi-calendar-date fs-4 text-secondary"></i>
                            </span>
                            {{ form.fecha_entrega_estimada }}
                        </div>
                        <div class="error-message">
                            {% if form.fecha_entrega_estimada.errors %}
                            {% for error in form.fecha_entrega_estimada.errors %}
                            <span class="text-danger">{{ error }}</span>
                            {% endfor %}
                            {% endif %}
                        </div>
                    </div>

                    <div class="repair-form-column">
                        <div class="input-group">
                            <span class="input-group-text form-span" id="basic-addon1">
                                <i class="bi bi-currency-dollar fs-4 text-secondary"></i>
                            </span>
                            {{ form.precio}}
                        </div>
                        <div class="error-message">
                            {% if form.precio.errors %}
                            {% for error in form.precio.errors %}
                            <span class="text-danger">{{ error }}</span>
                            {% endfor %}
                            {% endif %}
                        </div>

                        <div class="input-group mt-3">
                            <span class="input-group-text form-span " id="basic-addon1">
                                <i class="bi bi-box-seam fs-4 text-secondary"></i>
                            </span>
                            {{ form.espacio_fisico}}
                        </div>
                        <div class="error-message">
                            {% if form.espacio_fisico.errors %}
                            {% for error in form.espacio_fisico.errors %}
                            <span class="text-danger">{{ error }}</span>
                            {% endfor %}
                            {% endif %}
                        </div>


                        <div class="input-group mt-3">
                            <span class="input-group-text form-span" id="basic-addon1">
                                <i class="bi bi-smartwatch fs-4 text-secondary"></i>
                            </span>
                            {{ form.estado }}
                        </div>
                        <div class="error-message">
                            {% if form.estado.errors %}
                            {% for error in form.estado.errors %}
                            <span class="text-danger">{{ error }}</span>
                            {% endfor %}
                            {% endif %}
                        </div>

                        <div class="input-group mt-3">
                            <span class="input-group-text form-span" id="basic-addon1">
                                <i class="bi bi-person-fill fs-4 text-secondary"></i>
                            </span>
                            {{ form.tecnico}}
                        </div>
                        <div class="error-message">
                            {% if form.tecnico.errors %}
                            {% for error in form.tecnico.errors %}
                            <span class="text-danger">{{ error }}</span>
                            {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="form-buttons">
                    <button class="btn save" id="btnGuardar">GUARDAR</button>
                    <a href="{% url 'reparacion_list' %}">
                        <button type="button" class="btn cancel">CANCELAR</button>
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de confirmación simplificado -->
    <div class="modal fade" id="confirmationModal" data-bs-backdrop="static" data-bs-keyboard="false" 
        tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content text-center" style="background-color: #f1f1f1;">
                <div class="modal-body d-flex flex-column align-items-center" style="height: 200px;">
                    {% if editing %}
                    <h4 class="titulo m-0" id="modalMessage">REPARACIÓN ACTUALIZADA CORRECTAMENTE</h4>
                    {% else %}
                    <h4 class="titulo m-0" id="modalMessage">REPARACIÓN AGREGADA CORRECTAMENTE</h4>
                    {% endif %}
                    <a href="{% url 'reparacion_list' %}" class="btn save mt-3">VOLVER</a>
                </div>
            </div>
        </div>
    </div>

    {% endblock %}

    {% block javascript %}

    <script>
        $(document).ready(function () {
            $('#id_cliente').select2({
                theme: 'bootstrap-5',
                width: '100%',
                containerCssClass: 'select',
                dropdownCssClass: 'select',
                allowClear: true,
                placeholder: 'Seleccione un cliente',
                minimumInputLength: 1,
                language: {
                    noResults: function () {
                        return "No se encontraron resultados";
                    },
                    searching: function () {
                        return "Buscando...";
                    },
                    inputTooShort: function () {
                        return "Por favor ingrese 1 o más caracteres";
                    }
                },
                templateResult: formatCliente,
                templateSelection: formatCliente,
                matcher: function (params, data) {
                    if ($.trim(params.term) === '') {
                        return data;
                    }
                    if (data.text.toLowerCase().indexOf(params.term.toLowerCase()) > -1) {
                        return data;
                    }
                    return null;
                }
            });
            if ($('#id_cliente').hasClass('is-invalid')) {
                $('#id_cliente').next('.select2-container').find('.select2-selection').addClass('is-invalid');
            }
        });

        function formatCliente(cliente) {
            if (!cliente.id) {
                return cliente.text;
            }
            var parts = cliente.text.split(' - ');
            return $('<div class="select2-result-cliente">' +
                '<span class="select2-result-cliente__name">' + parts[0] + '</span>' + " " +
                '<span class="select2-result-cliente__apellido">' + parts[1] + '</span>' + " - " +
                '<span class="select2-result-cliente__phone">' + parts[2] + '</span>' +
                '</div>');
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>

    <script>
        flatpickr("#id_fecha_entrega_estimada", {
            dateFormat: "d/m/Y", // formato deseado
            locale: "es", // para español
            minDate: "today"
        });
    </script>

    <script>
    /**
     * Script de validación y envío de formulario para reparaciones
     * Implementa validación de cliente-lado y modal de confirmación
     */
    document.addEventListener("DOMContentLoaded", function () {
        console.log("DOM cargado, iniciando script de validación...");

        // Referencias a elementos DOM importantes
        const btnGuardar = document.getElementById('btnGuardar');
        const reparacionForm = document.getElementById('reparacionForm');
        const clienteSelect = document.querySelector('#id_cliente');

        // Definición de campos del formulario para validación
        const formFields = {
            marca_reloj: document.querySelector('#id_marca_reloj'),
            descripcion: document.querySelector('#id_descripcion'),
            codigo_orden: document.querySelector('#id_codigo_orden'),
            fecha_entrega_estimada: document.querySelector('#id_fecha_entrega_estimada'),
            precio: document.querySelector('#id_precio'),
            espacio_fisico: document.querySelector('#id_espacio_fisico'),
            tecnico: document.querySelector('#id_tecnico'),
        };

        // Inicializar el modal
        let modal;
        try {
            modal = new bootstrap.Modal(document.getElementById('confirmationModal'), {
                backdrop: 'static',  // Evita que el modal se cierre al hacer clic fuera
                keyboard: false      // Evita que el modal se cierre con la tecla ESC
            });
            console.log("Modal inicializado correctamente");
            
            // Verificar si hay un parámetro de éxito en la URL
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('success') === 'true') {
                console.log("Parámetro success detectado, mostrando modal...");
                // El setTimeout da tiempo al DOM para cargar completamente
                setTimeout(() => {
                    modal.show();
                }, 300);
            }
        } catch (e) {
            console.error("Error al inicializar el modal:", e);
        }

        // Función auxiliar para preparar el div de error
        function prepareErrorDiv(field) {
            let errorDiv = field.parentElement.nextElementSibling;
            if (!errorDiv || !errorDiv.classList.contains('error-message')) {
                errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                field.parentElement.after(errorDiv);
            }
            return errorDiv;
        }

        // Función que centraliza las reglas de validación por campo - refactorizada
        function getFieldValidation(fieldName, value) {
            // Objeto de validaciones por campo
            const validations = {
                marca_reloj: () => {
                    if (!value) {
                        return { isValid: false, errorMessage: 'La marca del reloj es obligatoria' };
                    }
                    return { isValid: true, errorMessage: '' };
                },
                
                descripcion: () => {
                    if (!value) {
                        return { isValid: false, errorMessage: 'La descripción es obligatoria' };
                    }
                    if (value.length < 10) {
                        return { isValid: false, errorMessage: 'La descripción debe tener al menos 10 caracteres' };
                    }
                    return { isValid: true, errorMessage: '' };
                },
                
                precio: () => {
                    if (!value) {
                        return { isValid: false, errorMessage: 'El precio es obligatorio' };
                    }
                    if (isNaN(value) || parseFloat(value) <= 0) {
                        return { isValid: false, errorMessage: 'El precio debe ser un número mayor que cero' };
                    }
                    return { isValid: true, errorMessage: '' };
                },
                
                // Campos con validación simple (solo requeridos)
                codigo_orden: () => validateRequiredField('código de orden'),
                fecha_entrega_estimada: () => validateRequiredField('fecha de entrega estimada'),
                espacio_fisico: () => validateRequiredField('espacio físico'),
                tecnico: () => validateRequiredField('técnico')
            };
            
            // Función auxiliar para validar campos requeridos
            function validateRequiredField(label) {
                if (!value) {
                    return { isValid: false, errorMessage: `El ${label} es obligatorio` };
                }
                return { isValid: true, errorMessage: '' };
            }
            
            // Ejecutar la validación correspondiente o usar validación por defecto
            return validations[fieldName] ? 
                validations[fieldName]() : 
                { isValid: true, errorMessage: '' };
        }

        // Función de validación de campo individual
        function validateField(field) {
            if (!field) return false;
            
            const fieldName = field.id.replace('id_', '');
            const errorDiv = prepareErrorDiv(field);
            const value = field.value.trim();
            
            // Obtener el resultado de validación desde la función centralizada
            const result = getFieldValidation(fieldName, value);
            
            // Actualizar UI según validación
            if (!result.isValid) {
                field.classList.add('is-invalid');
                errorDiv.innerHTML = `<span class="text-danger">${result.errorMessage}</span>`;
                return false;
            } else {
                field.classList.remove('is-invalid');
                errorDiv.innerHTML = '';
                return true;
            }
        }

        // Función global para validación completa del formulario
        function validateForm() {
            let isValid = true;

            // Validar cliente (Select2)
            const clienteErrorDiv = document.querySelector('.form-field .error-message');

            if (!clienteSelect.value) {
                isValid = false;
                clienteSelect.classList.add('is-invalid');

                // También aplicar el estilo al contenedor Select2
                const select2Container = clienteSelect.nextElementSibling;
                if (select2Container) {
                    select2Container.querySelector('.select2-selection').classList.add('is-invalid');
                }

                if (clienteErrorDiv) {
                    clienteErrorDiv.innerHTML = '<span class="text-danger">Debe seleccionar un cliente</span>';
                } else {
                    // Si no existe div de error, crearlo
                    const newErrorDiv = document.createElement('div');
                    newErrorDiv.className = 'error-message';
                    newErrorDiv.innerHTML = '<span class="text-danger">Debe seleccionar un cliente</span>';
                    clienteSelect.closest('.form-field').appendChild(newErrorDiv);
                }
            } else {
                clienteSelect.classList.remove('is-invalid');

                // Quitar estilo del contenedor Select2
                const select2Container = clienteSelect.nextElementSibling;
                if (select2Container) {
                    select2Container.querySelector('.select2-selection').classList.remove('is-invalid');
                }

                if (clienteErrorDiv) {
                    clienteErrorDiv.innerHTML = '';
                }
            }

            // Validar resto de campos
            for (const fieldName in formFields) {
                const field = formFields[fieldName];
                if (field && !validateField(field)) {
                    isValid = false;
                }
            }

            return isValid;
        }

        // Limpiar errores al iniciar
        function clearAllErrors() {
            if (clienteSelect) {
                clienteSelect.classList.remove('is-invalid');
                const clienteErrorDiv = document.querySelector('.form-field .error-message');
                if (clienteErrorDiv) {
                    clienteErrorDiv.innerHTML = '';
                }
            }

            // Limpiar todos los campos de formulario
            document.querySelectorAll('.form-control, select').forEach(field => {
                field.classList.remove('is-invalid');
            });

            // Limpiar todos los mensajes de error
            document.querySelectorAll('.error-message').forEach(div => {
                div.innerHTML = '';
            });
        }

        // Configurar validación en tiempo real
        function setupRealTimeValidation() {
            // Validar Select2 al cambiar
            $('#id_cliente').on('change', function () {
                const errorDiv = document.querySelector('.form-field .error-message');

                if (this.value) {
                    clienteSelect.classList.remove('is-invalid');
                    if (errorDiv) {
                        errorDiv.innerHTML = '';
                    }
                    // Quitar estilo del contenedor Select2
                    const select2Container = clienteSelect.nextElementSibling;
                    if (select2Container) {
                        select2Container.querySelector('.select2-selection').classList.remove('is-invalid');
                    }
                } else {
                    clienteSelect.classList.add('is-invalid');
                    if (errorDiv) {
                        errorDiv.innerHTML = '<span class="text-danger">Debe seleccionar un cliente</span>';
                    }
                    // Aplicar estilo al contenedor Select2
                    const select2Container = clienteSelect.nextElementSibling;
                    if (select2Container) {
                        select2Container.querySelector('.select2-selection').classList.add('is-invalid');
                    }
                }
            });

            // Asignar eventos de validación en tiempo real a campos normales
            for (const fieldName in formFields) {
                const field = formFields[fieldName];
                if (field) {
                    field.addEventListener('blur', function () {
                        validateField(this);
                    });

                    field.addEventListener('input', function () {
                        this.classList.remove('is-invalid');
                        const errorDiv = this.parentElement.nextElementSibling;
                        if (errorDiv && errorDiv.classList.contains('error-message')) {
                            errorDiv.innerHTML = '';
                        }
                    });
                }
            }
        }

        // Configurar handler para el botón guardar
        function setupSubmitHandler() {
            if (!btnGuardar) {
                console.error("BOTÓN GUARDAR NO ENCONTRADO. Verificar ID del botón.");
                return;
            }
            
            console.log("Botón guardar encontrado, añadiendo evento click");
            btnGuardar.addEventListener('click', function (event) {
                console.log("Botón guardar clickeado");
                event.preventDefault(); // Prevenir envío automático

                // Validar formulario
                const isFormValid = validateForm();
                console.log("¿Formulario válido?", isFormValid);

                if (isFormValid) {
                    handleValidFormSubmission();
                } else {
                    handleInvalidFormSubmission();
                }
            });
        }

        // Manejar envío de formulario válido
        function handleValidFormSubmission() {
            console.log("Formulario validado, preparando para envío AJAX");

            // Obtener el token CSRF
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            // Preparar formulario para envío
            const formData = new FormData(reparacionForm);
            formData.append('confirmar', 'true');
            
            
            // Enviar con Fetch API
            fetch(reparacionForm.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrftoken
                }
            })
            .then(response => {
                console.log("Respuesta recibida:", response);
                return response.json().then(data => {
                    // Incluir status en el objeto de datos para verificar después
                    return { ...data, status: response.status };
                });
            })
            .then(data => {
                console.log("Datos de respuesta:", data);
                
                if (data.success) {
                    handleSuccessResponse(data);
                } else {
                    handleErrorResponse(data);
                }
            })
            .catch(error => {
                console.error('Error en la solicitud AJAX:', error);
                
                // Mostrar mensaje de error más descriptivo
                alert("Ocurrió un error al procesar la solicitud. Por favor, intente nuevamente.");
            });
        }

        // Manejar respuesta exitosa
        function handleSuccessResponse(data) {
            console.log("Operación exitosa, redirigiendo...");
            // Redirigir a la misma página con parámetro success=true
            window.location.href = `${window.location.pathname}?success=true`;
        }

        // Manejar respuesta con errores
        function handleErrorResponse(data) {
            console.error("El servidor reportó un error:", data);
            
            // Procesamiento de errores
            if (data.errors) {
                // Iterar sobre los errores y mostrarlos en los campos correspondientes
                Object.entries(data.errors).forEach(([fieldName, errorMessage]) => {
                    console.log(`Error en campo ${fieldName}:`, errorMessage);
                    
                    const fieldElement = document.getElementById(`id_${fieldName}`);
                    if (fieldElement) {
                        // Marcar campo como inválido
                        fieldElement.classList.add('is-invalid');
                        
                        // Encontrar o crear div de error
                        let errorDiv = fieldElement.parentElement.nextElementSibling;
                        if (!errorDiv || !errorDiv.classList.contains('error-message')) {
                            errorDiv = document.createElement('div');
                            errorDiv.className = 'error-message';
                            fieldElement.parentElement.after(errorDiv);
                        }
                        
                        // Mostrar mensaje de error
                        errorDiv.innerHTML = `<span class="text-danger">${errorMessage}</span>`;
                    } else {
                        console.warn(`No se encontró el campo para el error: ${fieldName}`);
                    }
                });
                
                // Scroll al primer error
                const firstErrorField = document.querySelector('.is-invalid');
                if (firstErrorField) {
                    firstErrorField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    if (firstErrorField.tagName !== 'SELECT') {
                        firstErrorField.focus();
                    }
                }
            } else if (data.message) {
                console.error("Mensaje de error:", data.message);
                // Mostrar mensaje general de error
                alert(data.message);
            }
        }

        // Manejar envío de formulario inválido
        function handleInvalidFormSubmission() {
            console.log("Formulario inválido, no se muestra el modal");

            // Hacer scroll al primer campo con error
            const firstError = document.querySelector('.is-invalid');
            if (firstError) {
                console.log("Haciendo scroll al primer error");
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // Intentar dar foco al campo con error
                if (firstError.tagName === 'INPUT' || firstError.tagName === 'SELECT') {
                    firstError.focus();
                }
            }
        }

        // Configurar validación para envío tradicional (respaldo)
        function setupFormSubmitValidation() {
            if (!reparacionForm) {
                console.error("FORMULARIO NO ENCONTRADO. Verificar ID del formulario.");
                return;
            }
            
            reparacionForm.addEventListener('submit', function (e) {
                console.log("Formulario enviado, validando...");
                const isFormValid = validateForm();
                console.log("¿Formulario válido?", isFormValid);

                if (!isFormValid) {
                    console.log("Validación fallida, deteniendo envío");
                    e.preventDefault();

                    // Scroll al primer error
                    const firstError = document.querySelector('.is-invalid');
                    if (firstError) {
                        firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                } else {
                    console.log("Formulario válido, procediendo con el envío");
                }
            });
        }

        // Inicializar todas las configuraciones
        clearAllErrors();
        setupRealTimeValidation();
        setupSubmitHandler();
        setupFormSubmitValidation();
    });
    </script>
    {% endblock %}