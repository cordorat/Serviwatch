{% extends 'base.html' %}
{% load static %}
{% block content %}
<style>
  .custom-table-usuario td a {
    display: inherit;
  }
</style>

<div class="main-content">
  <!-- Botón Agregar reparación -->
  <div class="header-icons">
    <h2 class="titulo">CLIENTE</h2>
    <a href="{% url 'cliente_create' %}" class="btn btn-add me-3"> Agregar Cliente</a>
  </div>
  <br>
  
  <!-- Campo de búsqueda AJAX -->
  <div class="search-container mb-3">
    <div class="input-group">
      <input type="text" id="search-cliente" class="form-control" placeholder="Buscar cliente">
      <button id="btn-search" class="btn btn-searchf" type="button">
        <i class="bi bi-search"></i> Buscar
      </button>
    </div>
  </div>
  
  <!-- Lista de reparaciones -->
  <div class="table-container">
    <div id="no-results-message" class="alert alert-info text-center" style="display: none;">
      <i class="bi bi-exclamation-circle me-2"></i> El cliente no existe
    </div>
    <table class="table table-hover align-middle custom-table custom-table-usuario">
      <thead class="table-header">
        <tr>
          <th>Nombre</th>
          <th>Apellido</th>
          <th>Teléfono</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for cliente in clientes %}
        <tr>
          <td>{{ cliente.nombre }}</td>
          <td>{{ cliente.apellido }}</td>
          <td>{{ cliente.telefono }}</td>
          <td>
            <a href="{% url 'cliente_editar' id=cliente.id %}" class="btn btn-sm btn-outline-primary" title="Editar cliente">
              <i class="bi bi-pencil-square"></i>
            </a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% if messages %}
  {% for message in messages %}
  {% if message.tags == "success" %}
  <!-- Mostrar el modal SOLO si el mensaje es de tipo "success" -->
  <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
      <div class="modal-content">
        <div class="modal-header justify-content-center">
          <h5 class="modal-title" id="confirmModalLabel">
            {% if 'editado' in message.message %}
              CLIENTE EDITADO
            {% else %}
              CLIENTE AGREGADO
            {% endif %}
          </h5>
        </div>
        <div class="modal-footer justify-content-center">
          <button type="button" class="btn-cerrar" data-bs-dismiss="modal">VOLVER</button>
        </div>
      </div>
    </div>
  </div>
  <script>
    var modal = new bootstrap.Modal(document.getElementById('confirmModal'));
    modal.show();
  </script>
  {% endif %}
  {% endfor %}
  {% endif %}
  <!-- Paginación -->
  {% if is_paginated %}
  <nav aria-label="Page navigation">
      <ul class="pagination">
          <li class="page-item">
              <a class="page-link" href="{% if page_obj.has_previous %}?page={{ page_obj.previous_page_number }}{% endif %}">
                  <span aria-hidden="true">&laquo;</span>
              </a>
          </li>
          {% for num in page_obj.paginator.page_range %}
          <li class="page-item {% if page_obj.number == num %}active{% endif %}">
              <a class="page-link" href="?page={{ num }}">{{ num }}</a>
          </li>
          {% endfor %}
          <li class="page-item">
              <a class="page-link" href="{% if page_obj.has_next %}?page={{ page_obj.next_page_number }}{% endif %}" aria-label="Next">
                  <span aria-hidden="true">&raquo;</span>
              </a>
          </li>
      </ul>
  </nav>
  {% endif %}
</div>

<!-- Estilos adicionales para el campo de búsqueda -->
<style>
  .search-container {
    max-width: 500px;
  }
  
  #search-cliente {
    border-radius: 4px 0 0 4px;
  }
  
  .btn-primary {
    border-radius: 0 4px 4px 0;
  }
</style>

<!-- Script para búsqueda AJAX -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.1/jquery-ui.min.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.1/themes/base/jquery-ui.css">

<script>
$(document).ready(function() {
  // Configurar autocomplete para la búsqueda
  $("#search-cliente").autocomplete({
    source: function(request, response) {
      $.ajax({
        url: "{% url 'cliente_search' %}",
        data: { term: request.term },
        dataType: "json",
        success: function(data) {
          response(data);
        }
      });
    },
    minLength: 2,
    select: function(event, ui) {
      // Llenar los datos del cliente seleccionado
      $(this).val(ui.item.value);
      return false;
    }
  });
  
  // Función de búsqueda al hacer clic en el botón
  $("#btn-search").click(function() {
    buscarClientes();
  });
  
  // Búsqueda al presionar Enter
  $("#search-cliente").keypress(function(e) {
    if (e.which == 13) {
      e.preventDefault();
      buscarClientes();
    }
  });
  
  // Función para filtrar la tabla según el término de búsqueda
  function buscarClientes() {
  var searchTerm = $("#search-cliente").val().toLowerCase();
  var found = false;

  // Si está vacío, mostrar todos
  if (searchTerm.length < 2) {
    $("table tbody tr").show();
    $("#no-results-message").hide();
    return;
  }

  $("table tbody tr").each(function() {
    var nombre = $(this).find("td:nth-child(1)").text().toLowerCase();
    var apellido = $(this).find("td:nth-child(2)").text().toLowerCase();
    var telefono = $(this).find("td:nth-child(3)").text().toLowerCase();

    if (
      nombre.includes(searchTerm) ||
      apellido.includes(searchTerm) ||
      telefono.includes(searchTerm) ||
      (nombre + " " + apellido).includes(searchTerm)
    ) {
      $(this).show();
      found = true;
    } else {
      $(this).hide();
    }
  });

  // Mostrar u ocultar el mensaje
  if (found) {
    $("#no-results-message").hide();
  } else {
    $("#no-results-message").show();
  }
}
});
</script>
{% endblock %}