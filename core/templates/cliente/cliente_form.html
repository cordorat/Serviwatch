{% extends 'base.html' %}

{% load static %}
{% block title %}Agregar Cliente{% endblock %}

{% block content %}
<h2 class="titulo">
  {% if modo == 'editar' %}
  EDITAR CLIENTE
  {% else %}
  AGREGAR CLIENTE
  {% endif %}
</h2>
<h4>DATOS PERSONALES</h4>

<div>
  <div class="left-column">
    <form method="POST" class="custom-form" id="clienteForm" novalidate>
      {% csrf_token %}

      <div class="form-group">
        <div class="input-group mb-3">
          <span class="input-group-text form-span" id="basic-addon1">
            <i class="bi bi-person-fill fs-4 text-secondary"></i>
          </span>
          {{ form.nombre }}
        </div>
        {% if form.nombre.errors %}
        <div class="form-error">{{ form.nombre.errors.0 }}</div>
        {% endif %}
      </div>

      <div class="form-group">
        <div class="input-group mb-3">
          <span class="input-group-text form-span" id="basic-addon1">
            <i class="bi bi-person-fill fs-4 text-secondary"></i>
          </span>
          {{ form.apellido }}
        </div>

        {% if form.apellido.errors %}
        <div class="form-error">{{ form.apellido.errors.0 }}</div>
        {% endif %}
      </div>

      <div class="form-group">
        <div class="input-group mb-3">
          <span class="input-group-text form-span" id="basic-addon1">
            <i class="bi bi-telephone-fill fs-4 text-secondary"></i>
          </span>
          {{ form.telefono }}

        </div>
        {% if form.telefono.errors %}
        <div class="form-error">{{ form.telefono.errors.0 }}</div>
        {% endif %}

      </div>

      <div class="form-buttons">
        <button class="btn save" id="btnGuardarcliente">GUARDAR</button>
        <a href="{% url 'cliente_list' %}">
          <button type="button" class="btn cancel">CANCELAR</button>
        </a>

      </div>

    </form>
  </div>

  <div class="right-column">
    <img src="{% static 'images/reloj-pagina.png' %}" alt="reloj" class="reloj-img">
  </div>

</div>

<!-- Modal de confirmación simplificado -->
<div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel"
  aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center" style="background-color: #f1f1f1;">
      <div class="modal-body d-flex justify-content-center align-items-center" style="height: 200px;">
        {% if modo == 'editar' %}
        <h4 class="titulo m-0" id="modalMessage">CLIENTE ACTUALIZADO CORRECTAMENTE</h4>
        {% else %}
        <h4 class="titulo m-0" id="modalMessage">CLIENTE AGREGADO CORRECTAMENTE</h4>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block javascript %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const btnGuardarcliente = document.getElementById('btnGuardarcliente');
    const clienteForm = document.getElementById('clienteForm');
    const modal = new bootstrap.Modal(document.getElementById('confirmationModal'));
    
    // Referencias a los campos
    const nombreField = document.querySelector('input[name="nombre"]');
    const apellidoField = document.querySelector('input[name="apellido"]');
    const telefonoField = document.querySelector('input[name="telefono"]');
    const allFields = [nombreField, apellidoField, telefonoField];

    // Marcar campos con errores del servidor
    document.querySelectorAll('.form-error').forEach(function (errorMessage) {
      var input = errorMessage.closest('.form-group')?.querySelector('input');
      if (input) {
        input.classList.add('is-invalid');
      }
    });

    // Función para obtener el mensaje de error basado en el tipo de campo y su valor
    function getFieldErrorMessage(fieldName, value) {
      // Si está vacío
      if (!value) {
        if (fieldName === 'nombre') return 'El nombre es obligatorio.';
        if (fieldName === 'apellido') return 'El apellido es obligatorio.';
        if (fieldName === 'telefono') return 'El número de teléfono es obligatorio.';
        return '';
      }
      
      // Validaciones específicas para cada tipo de campo
      if (fieldName === 'nombre' || fieldName === 'apellido') {
        if (!/^[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+$/.test(value)) {
            return `El ${fieldName} solo debe contener letras.`;
        }
      }
      
      if (fieldName === 'telefono') {
        if (!/^\d{10}$/.test(value)) {
            return 'El número de teléfono debe contener exactamente 10 dígitos.';
        }
      }
      
      return ''; // No hay error
    }

    // Función para crear y mostrar un mensaje de error
    function showFieldError(field, message) {
      const errorDiv = document.createElement('div');
      errorDiv.className = 'form-error';
      errorDiv.textContent = message;
      field.parentElement.appendChild(errorDiv);
      field.classList.add('is-invalid');
    }

    // Función para validar un campo
    function validateField(field) {
      // Remover error anterior
      const formGroup = field.closest('.form-group');
      let errorElement = formGroup.querySelector('.form-error');
      if (errorElement) {
        errorElement.remove();
      }
        
      // Obtener valor y validar
      const value = field.value.trim();
      const errorMessage = getFieldErrorMessage(field.name, value);
        
      // Mostrar error o marcar como válido
      if (errorMessage) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'form-error';
        errorDiv.textContent = errorMessage;
        formGroup.appendChild(errorDiv);
        field.classList.add('is-invalid');
        return false;
      } else {
        field.classList.remove('is-invalid');
        return true;
      }
    }

    // Validación al salir del input
    allFields.forEach(field => {
      field.addEventListener('blur', function () {
        validateField(this);
      });

      field.addEventListener('input', function () {
        this.classList.remove('is-invalid');
        const formGroup = this.closest('.form-group');
        const error = formGroup.querySelector('.form-error');
        if (error) error.remove();
      });
    });

    // Función para validar todos los campos
    function validateAllFields() {
      let isValid = true;
      allFields.forEach(field => {
        if (!validateField(field)) {
          isValid = false;
        }
      });
      return isValid;
    }

    // IMPORTANTE: Manejar el clic del botón con validación
    btnGuardarcliente.addEventListener('click', function (event) {
      event.preventDefault(); // Evita el envío inmediato
      
      // Validar todos los campos primero
      const isValid = validateAllFields();
      
      if (isValid) {
        // Agregar un campo oculto solo si no existe
        if (!document.querySelector('input[name="confirmar"]')) {
          const hiddenInput = document.createElement('input');
          hiddenInput.type = 'hidden';
          hiddenInput.name = 'confirmar';
          hiddenInput.value = 'true';
          clienteForm.appendChild(hiddenInput);
        }
        
        console.log("Formulario válido, mostrando modal...");
        // Mostrar el modal
        modal.show();
        
        // Enviar el formulario después de 3 segundos
        setTimeout(function () {
          clienteForm.submit();
        }, 3000);
      } else {
        console.log("Formulario inválido, no se muestra el modal");
        // Hacer scroll al primer error
        const firstError = document.querySelector('.is-invalid');
        if (firstError) {
          firstError.focus();
          firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }
    });

    // Evitar que el formulario se envíe automáticamente
    clienteForm.addEventListener('submit', function(e) {
      // Solo permitir envío automático si viene del botón guardar
      if (!document.querySelector('input[name="confirmar"]')) {
        e.preventDefault();
      }
    });
    
    // Limpiar campos al recargar
    window.addEventListener('pageshow', function (event) {
      if (event.persisted || performance.getEntriesByType("navigation")[0].type === "reload") {
        allFields.forEach(input => input.value = '');
      }
    });
  });
</script>

{% endblock %}