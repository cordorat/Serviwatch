{% extends 'base.html' %}
{% load static %}

{% block content %}

<style>
    .titulo_venta {
        padding-left: 0px !important;
    }

    .input-group.input-group-venta>.form-control.form-control-venta {
        height: auto;
        border-top-right-radius: 4px !important;
        border-bottom-right-radius: 4px !important;
    }

    .input-group.input-group-venta>.btn.btn-search {
        border-radius: 4px !important;
    }

    .header-icons-venta {
        gap: 0px;
        justify-content: start;
    }

    .filtro-container-venta {
        display: inline-block;
        vertical-align: middle;
    }

    .filtro-container-venta .form-select {
        min-width: 120px;
        border-radius: 4px;
        border: 1px solid #ced4da;
        height: 38px;
        font-family: "Montserrat", sans-serif;
        font-size: 16px;
    }

    .text-muted-venta {
        font-weight: bold !important;
    }

    .report-button-container {
        margin-left: auto;
        display: flex;
        align-items: center;
    }

    .venta-table>:not(caption)>*>* {
        box-shadow: none !important;
    }

    .custom-table-venta tbody tr td {
        white-space: normal;
    }

    .custom-table tbody tr {
        height: auto;
    }

    .main-content {
        height: auto;
        min-height: 100%;
        overflow-y: auto;
        padding-bottom: 30px;
    }

    .cantidad-input {
        width: 80px !important; /* Reducir ancho */
        text-align: center;
        padding-right: 5px; /* Reducir padding derecho */
        padding-left: 5px; /* Reducir padding izquierdo */
    }
    
    /* Asegurar que los números grandes se muestren correctamente */
    .cantidad-input::-webkit-inner-spin-button,
    .cantidad-input::-webkit-outer-spin-button {
        margin-left: 0;
    }
    
    /* Ajustar el contenedor del grupo de formulario */
    .form-group {
        display: flex;
        flex-direction: column;
        align-items: flex-start; 
        width: 100%;
        position: relative;
    }
    
    /* Asegurar que el mensaje de error esté alineado con el input */
    .error-message {
        width: 80px; /* Mismo ancho que el input */
        text-align: left;
        font-size: 12px; /* Texto más pequeño */
    }

    /* Estilos para hacer que la tabla ocupe más espacio */
    .main-content {
        width: 100%;
        padding-right: 0;
        padding-left: 0;
        margin-right: 0;
        margin-left: 0;
        max-width: none;
    }

    .table-container {
        width: 100%;
        max-width: 100%;
        margin: 0;
        padding: 0;
    }

    .venta-table {
        width: 100% !important;
        max-width: none !important;
        margin: 0 !important;
    }

    /* Asegurar que las celdas de la tabla tengan un tamaño adecuado */
    .venta-table th,
    .venta-table td {
        padding: 12px 8px;
        min-width: 100px;
    }

    /* Ajustar el ancho del contenedor del formulario */
    #venta-form {
        width: 100%;
        max-width: none;
        margin: 0;
        padding: 0;
    }

    /* Eliminar cualquier restricción de ancho en el contenedor principal */
    .container,
    .container-fluid {
        max-width: none;
        padding-right: 0;
        padding-left: 0;
    }

</style>
<style>
    /* Estilos para los mensajes de error */
    .error-message.pila {
        color: #dc3545;
        font-size: 0.875rem;
        margin-top: 0.25rem;
        display: none;
        width: 80px; /* Mismo ancho que el input */
        text-align: left;
        /* Eliminar cualquier margen adicional */
        margin-left: 0;
        padding-left: 0;
    }

    .input-error {
        border: 2px solid #dc3545 !important;
        box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25);
    }

    /* Mensaje de error global */
    .error-banner {
        color: #dc3545;
        padding: 10px 15px;
        border-radius: 4px;
        margin-bottom: 15px;
        display: none;
        border: 1px solid #dc3545;
        animation: fadeIn 0.5s;
    }
</style>

<div class="main-content">
    <div class="header-icons">
        <h2 class="titulo">VENTA DE PILAS</h2>
    </div>

    <!-- Botón para procesar venta -->
    <div class="header-icons header-icons-venta">
        <button type="button" id="btn-procesar" class="btn btn-add me-3">Procesar venta</button>
    </div>
    <div class="error-banner" id="error-banner">
        <span id="error-message">Error en la validación</span>
    </div>

    <!-- Modal de confirmación -->
    <div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content text-center" style="background-color: #f1f1f1;">
                <div class="modal-body d-flex justify-content-center align-items-center" style="height: 200px;">
                    <h4 class="titulo m-0">
                        PILA VENDIDA
                    </h4>
                </div>
            </div>
        </div>
    </div>

    <br>

    <!-- Lista de pilas para venta -->
    <div class="table-container">
        <form method="post" action="{% url 'ventaPila_create' %}" id="venta-form">
            {% csrf_token %}
            <table class="table table-hover align-middle custom-table venta-table">
                <thead>
                    <tr>
                        <th>Código</th>
                        <th>Precio</th>
                        <th>Stock Disponible</th>
                        <th>Cantidad para Venta</th>
                    </tr>
                </thead>
                <tbody>
                    {% for pila in pilas %}
                    <tr>
                        <td>{{ pila.codigo }}</td>
                        <td>${{ pila.precio }}</td>
                        <td class="{% if pila.cantidad|add:"0" < 10 %}text-danger{% endif %} fw-bold">
                            {{ pila.cantidad }}
                        </td>
                        <td class="text-start">
                            <div class="form-group">
                                <input type="number" name="cantidad_{{ pila.id }}" 
                                    id="cantidad_{{ pila.id }}"
                                    class="form-control cantidad-input" 
                                    placeholder="0" min="0" max="{{ pila.cantidad }}"
                                    data-max-stock="{{ pila.cantidad }}">
                                <div class="error-message pila" id="error_cantidad_{{ pila.id }}"></div>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="text-center">No hay pilas registradas</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </form>
    </div>

    <!-- Paginación -->
    {% if pilas.has_other_pages %}
    <nav aria-label="Paginación" class="mt-4">
        <ul class="pagination justify-content-center">
            {% if pilas.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page=1" aria-label="Primera">
                        <span aria-hidden="true">&laquo;&laquo;</span>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ pilas.previous_page_number }}" aria-label="Anterior">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
            {% endif %}

            {% for i in pilas.paginator.page_range %}
                <li class="page-item {% if pilas.number == i %}active{% endif %}">
                    <a class="page-link" href="?page={{ i }}">{{ i }}</a>
                </li>
            {% endfor %}

            {% if pilas.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ pilas.next_page_number }}" aria-label="Siguiente">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ pilas.paginator.num_pages }}" aria-label="Última">
                        <span aria-hidden="true">&raquo;&raquo;</span>
                    </a>
                </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>

<!-- Script para validar stock, enviar formulario y mostrar modal -->
<script>
    document.addEventListener('DOMContentLoaded', function() {

        // Agregar validación de stock a todos los inputs de cantidad
        const cantidadInputs = document.querySelectorAll('.cantidad-input');
        cantidadInputs.forEach(function(input) {
            input.addEventListener('change', function() {
                const maxStock = this.getAttribute('data-max-stock');
                validateStock(this, maxStock);
            });
        });

        // Configurar botón para enviar formulario
        document.getElementById('btn-procesar').addEventListener('click', function() {
            // Limpiar mensajes de error previos
            clearErrors();
            
            // Verificar si hay al menos una pila seleccionada
            let haySeleccion = false;
            const inputs = document.querySelectorAll('input[type=number]');
            inputs.forEach(function(input) {
                if (input.value && parseInt(input.value) > 0) {
                    haySeleccion = true;
                }
            });

            if (haySeleccion) {
                // Verificar stock antes de enviar
                let stockValido = true;
                inputs.forEach(function(input) {
                    if (input.value && parseInt(input.value) > 0) {
                        const maxStock = input.getAttribute('max');
                        if (parseInt(input.value) > parseInt(maxStock)) {
                            stockValido = false;
                            markInputError(input, `Excede el stock disponible (${maxStock})`);
                        }
                    }
                });

                if (stockValido) {
                    // Marcar que se está procesando una venta
                    localStorage.setItem('procesando_venta', 'true');
                    document.getElementById('venta-form').submit();
                }
            } else {
                // Mostrar mensaje de error
                showErrorBanner('Debe seleccionar al menos una pila para la venta');
                
                // Resaltar todos los campos como posibles opciones
                inputs.forEach(function(input) {
                    input.classList.add('input-error');
                    input.classList.add('shake');
                    setTimeout(() => input.classList.remove('shake'), 500);
                });
            }
        });
        
        // Verificar si venimos de procesar una venta
        if (localStorage.getItem('procesando_venta') === 'true') {
            // Eliminar la marca para no mostrar el modal en futuras cargas
            localStorage.removeItem('procesando_venta');
            
            // Mostrar modal de confirmación
            setTimeout(function() {
                try {
                    var confirmationModal = new bootstrap.Modal(document.getElementById('confirmationModal'));
                    confirmationModal.show();
                    
                    // Cerrar el modal después de 3 segundos
                    setTimeout(function() {
                        confirmationModal.hide();
                    }, 3000);
                } catch (error) {
                    console.error("Error al mostrar el modal:", error);
                    alert("Venta procesada correctamente");
                }
            }, 300);
        }
    });

    // Validar stock en tiempo real
    function validateStock(input, maxStock) {
        // Eliminar mensaje de error anterior
        const errorDiv = document.getElementById('error_' + input.id);
        if (errorDiv) {
            errorDiv.style.display = 'none';
            errorDiv.textContent = '';
        }
        
        // Quitar estilo de error
        input.classList.remove('input-error');
        
        // Validar valor
        if (input.value && parseInt(input.value) > parseInt(maxStock)) {
            markInputError(input, `Excede el stock disponible (${maxStock})`);
        }
        
        if (input.value && parseInt(input.value) < 0) {
            input.value = 0;
        }
        
        // Ocultar banner de error global si algún campo tiene valor
        if (input.value && parseInt(input.value) > 0) {
            hideErrorBanner();
        }
    }
    
    // Función para marcar un input como error
    function markInputError(input, message) {
        input.classList.add('input-error');
        input.classList.add('shake');
        setTimeout(() => input.classList.remove('shake'), 500);
        
        const errorDiv = document.getElementById('error_' + input.id);
        if (errorDiv) {
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
    }
    
    // Función para limpiar todos los errores
    function clearErrors() {
        // Ocultar banner de error
        hideErrorBanner();
        
        // Limpiar errores de inputs
        const inputs = document.querySelectorAll('input[type=number]');
        inputs.forEach(function(input) {
            input.classList.remove('input-error');
            const errorDiv = document.getElementById('error_' + input.id);
            if (errorDiv) {
                errorDiv.style.display = 'none';
                errorDiv.textContent = '';
            }
        });
    }
    
    // Función para mostrar banner de error
    function showErrorBanner(message) {
        const banner = document.getElementById('error-banner');
        const errorMessage = document.getElementById('error-message');
        
        if (banner && errorMessage) {
            errorMessage.textContent = message;
            banner.style.display = 'block';
            banner.classList.add('shake');
            setTimeout(() => banner.classList.remove('shake'), 500);
        }
    }
    
    // Función para ocultar banner de error
    function hideErrorBanner() {
        const banner = document.getElementById('error-banner');
        if (banner) {
            banner.style.display = 'none';
        }
    }
</script>
{% endblock %}