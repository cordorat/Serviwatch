{% extends 'base.html' %}
{% load static %}

{% block title %}Cambiar Contraseña - Servi-Watch{% endblock %}

{% block content %}

<div>
    <div class="left-column">
        <h2 class="titulo">EDITAR PERFIL</h2>


        <h4> EDITAR PERFIL </h4>

        <form method="POST" novalidate class="custom-form" id="passwordForm" autocomplete="off">
            {% csrf_token %}
            <!-- Campo oculto para evitar autocompletado -->
            <input type="text" style="display:none" name="prevent_autofill" id="prevent_autofill" value="">
            <input type="password" style="display:none" name="prevent_autofill_pass" id="prevent_autofill_pass"
                value="">

            <!-- Contraseña actual -->
            <div class="mb-3 mt-4">
                <div class="input-group egreso-form custom-form">
                    <span class="input-group-text form-span" id="basic-addon1">
                        <i class="bi bi-lock fs-4 text-secondary"></i>
                    </span>
                    <input type="password" name="contrasenia_actual" id="id_contrasenia_actual"
                        class="form-control {% if form.contrasenia_actual.errors %}is-invalid{% endif %}"
                        placeholder="CONTRASEÑA ACTUAL" required autocomplete="off">
                    <span>
                        <i class="fa-solid fa-eye toggle-password" data-target="id_contrasenia_actual"></i>
                    </span>
                </div>
                <div class="error-container mt-1">
                    {% if form.contrasenia_actual.errors %}
                    {% for error in form.contrasenia_actual.errors %}
                    <div class="text-danger small">{{ error }}</div>
                    {% endfor %}
                    {% endif %}
                </div>
            </div>

            <!-- Contraseña nueva -->
            <div class="mb-3">
                <div class="input-group egreso-form custom-form">
                    <span class="input-group-text form-span" id="basic-addon2">
                        <i class="bi bi-key fs-4 text-secondary"></i>
                    </span>
                    <input type="password" name="contrasenia_nueva" id="id_contrasenia_nueva"
                        class="form-control {% if form.contrasenia_nueva.errors %}is-invalid{% endif %}"
                        placeholder="CONTRASEÑA NUEVA" required autocomplete="off">
                    <span>
                        <i class="fa-solid fa-eye toggle-password" data-target="id_contrasenia_nueva"></i>
                    </span>
                </div>
                <div class="error-container mt-1">
                    {% if form.contrasenia_nueva.errors %}
                    {% for error in form.contrasenia_nueva.errors %}
                    <div class="text-danger small">{{ error }}</div>
                    {% endfor %}
                    {% endif %}
                </div>
            </div>

            <!-- Confirmación de contraseña -->
            <div class="mb-3">
                <div class="input-group egreso-form custom-form">
                    <span class="input-group-text form-span" id="basic-addon3">
                        <i class="bi bi-check-circle fs-4 text-secondary"></i>
                    </span>
                    <input type="password" name="confirmacion_contrasenia" id="id_confirmacion_contrasenia"
                        class="form-control {% if form.confirmacion_contrasenia.errors %}is-invalid{% endif %}"
                        placeholder="CONFIRMAR CONTRASEÑA" required autocomplete="off">
                    <span>
                        <i class="fa-solid fa-eye toggle-password" data-target="id_confirmacion_contrasenia"></i>
                    </span>
                </div>
                <div class="error-container mt-1">
                    {% if form.confirmacion_contrasenia.errors %}
                    {% for error in form.confirmacion_contrasenia.errors %}
                    <div class="text-danger small">{{ error }}</div>
                    {% endfor %}
                    {% endif %}
                </div>
            </div>

            <!-- Errores no relacionados con campos específicos -->
            {% if form.non_field_errors %}
            <div class="error-container mt-2 mb-3">
                {% for error in form.non_field_errors %}
                <div class="text-danger small">{{ error }}</div>
                {% endfor %}
            </div>
            {% endif %}

            <div class="form-actions">
                <button type="button" id="btnCambiarPassword" class="btn-guardar">GUARDAR CAMBIOS</button>
            </div>
        </form>
    </div>

    <div class="right-column">
        <img src="{% static 'images/reloj-pagina.png' %}" alt="Reloj" class="clock">
    </div>

</div>

<!-- Modal de confirmación -->
<div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center" style="background-color: #f1f1f1;">
            <div class="modal-body d-flex justify-content-center align-items-center" style="height: 200px;">
                <h4 class="titulo m-0">CONTRASEÑA ACTUALIZADA CORRECTAMENTE</h4>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascript %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Referencias a elementos DOM
        const btnCambiarPassword = document.getElementById('btnCambiarPassword');
        const passwordForm = document.getElementById('passwordForm');
        const modal = new bootstrap.Modal(document.getElementById('confirmationModal'));

        // Referencias a los campos de contraseña
        const actualField = document.querySelector('input[name="contrasenia_actual"]');
        const nuevaField = document.querySelector('input[name="contrasenia_nueva"]');
        const confirmacionField = document.querySelector('input[name="confirmacion_contrasenia"]');
        const allFields = [actualField, nuevaField, confirmacionField];

        // Prevenir autocompletado y limpiar campos
        allFields.forEach(input => {
            if (!input) return;
            input.value = '';
            input.setAttribute('autocomplete', 'new-password-' + Math.random().toString(36).substring(2));
        });

        // Función principal de validación refactorizada
        function validateField(field) {
            // Remover error anterior
            const errorContainer = field.closest('.mb-3').querySelector('.error-container');
            errorContainer.innerHTML = '';

            const value = field.value.trim();
            
            // Validación básica para todos los campos
            let validationResult = validateBasicRequirements(field.name, value);
            
            // Validaciones específicas adicionales por tipo de campo
            if (!validationResult.errorMessage) {
                validationResult = validateSpecificFieldType(field.name, value);
            }

            // Actualizar UI según resultado
            updateValidationUI(field, errorContainer, validationResult.errorMessage);
            
            return !validationResult.errorMessage;
        }

        // Validación de requisitos básicos para todos los campos
        function validateBasicRequirements(fieldName, value) {
            if (!value) {
                return { errorMessage: 'Este campo es obligatorio' };
            } else if (value.length < 8) {
                return { errorMessage: 'La contraseña debe tener al menos 8 caracteres' };
            } else if (value.length > 16) {
                return { errorMessage: 'La contraseña no puede tener más de 16 caracteres' };
            }
            
            return { errorMessage: '' };
        }

        // Validaciones específicas por tipo de campo
        function validateSpecificFieldType(fieldName, value) {
            let errorMessage = '';
            
            if (fieldName === 'contrasenia_nueva') {
                errorMessage = validateNewPassword(value);
            } else if (fieldName === 'confirmacion_contrasenia') {
                errorMessage = validateConfirmationPassword(value);
            }
            
            return { errorMessage };
        }

        // Validación específica para contraseña nueva
        function validateNewPassword(value) {
            if (!/[A-Za-z]/.test(value)) {
                return 'La contraseña debe tener al menos una letra';
            }
            if (!/\d/.test(value)) {
                return 'La contraseña debe tener al menos un número';
            }
            if (!/[!@#$%^&*?]/.test(value)) {
                return 'La contraseña debe tener al menos un caracter especial';
            }
            return '';
        }

        // Validación específica para confirmación de contraseña
        function validateConfirmationPassword(value) {
            const nuevaValue = document.querySelector('input[name="contrasenia_nueva"]').value.trim();
            if (value !== nuevaValue) {
                return 'Las contraseñas no coinciden';
            }
            return '';
        }

        // Actualiza la UI según el resultado de la validación
        function updateValidationUI(field, errorContainer, errorMessage) {
            if (errorMessage) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'text-danger small';
                errorDiv.textContent = errorMessage;
                errorContainer.appendChild(errorDiv);
                field.classList.add('is-invalid');
            } else {
                field.classList.remove('is-invalid');
            }
        }

        // Validación al salir del input
        allFields.forEach(field => {
            if (!field) return;

            field.addEventListener('blur', function () {
                validateField(this);
            });

            field.addEventListener('input', function () {
                this.classList.remove('is-invalid');
                const errorContainer = this.closest('.mb-3').querySelector('.error-container');
                errorContainer.innerHTML = '';
            });
        });

        // Mostrar/ocultar contraseña
        const toggleIcons = document.querySelectorAll('.toggle-password');
        toggleIcons.forEach(icon => {
            icon.addEventListener('click', function () {
                const targetId = this.getAttribute('data-target');
                const input = document.getElementById(targetId);

                if (input) {
                    const type = input.type === 'password' ? 'text' : 'password';
                    input.type = type;

                    this.classList.toggle('fa-eye');
                    this.classList.toggle('fa-eye-slash');
                }
            });
        });

        // Manejar el botón de cambiar contraseña
        btnCambiarPassword.addEventListener('click', function () {
            // Validar todos los campos primero
            let isValid = true;

            allFields.forEach(field => {
                if (!field) return;
                if (!validateField(field)) {
                    isValid = false;
                }
            });

            if (isValid) {
                // Agregar un campo oculto para indicar la acción
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'cambiar_password';
                hiddenInput.value = 'true';
                passwordForm.appendChild(hiddenInput);

                // Mostrar el modal
                modal.show();

                // Enviar el formulario después de 3 segundos
                setTimeout(function () {
                    passwordForm.submit();
                }, 3000);
            }
        });
    });
</script>
{% endblock %}