{% extends 'base.html' %}
{% load humanize %}
{% load static %}

{% block content %}

<style>
    /* Estilos más específicos con !important para forzar la aplicación */
    .content {
        display: flex;
        justify-content: normal;
        align-items: flex-start;
        width: 100%;
        padding: 20px;
    }

    .confirmar-egreso-container {
        max-width: 900px;
        margin: 0 auto !important;
        padding: 20px;
    }
</style>

<div class="card-body text-center confirmar-egreso-container">
    <div style="background-color: #C7C7C7; padding: 1rem; border-radius: 25px; display: block; width: 100%;">
        <div class="text-center fw-bold mb-4">
            <h3 class="fw-bold">¿ESTA SEGURO QUE DESEAS AGREGAR EL <br> SIGUIENTE EGRESO?</h3>
        </div>

        <div class="d-flex justify-content-center text-center fw-bold mb-4">
            <div class="mx-4">
                <div>VALOR</div>
                <div class="text-dark mt-2">${{ egreso.valor|floatformat:0|intcomma }}</div>
            </div>
            <div class="mx-4">
                <div>FECHA</div>
                <div class="text-dark mt-2">{{ egreso.fecha }}</div>
            </div>
            <div class="mx-4">
                <div>DESCRIPCIÓN</div>
                <div class="text-dark mt-2">{{ egreso.descripcion }}</div>
            </div>
        </div>

        <form method="post" id="egresoForm" class="confirmar-egreso-container">
            {% csrf_token %}
            <div class="d-flex justify-content-center gap-3 100%">
                <button type="button" id="btnConfirmar" class="btn save">
                    <i class="fas fa-check me-2"></i>Confirmar
                </button>
                <button type="submit" name="editar" class="btn cancel">
                    <i class="fas fa-edit me-2"></i>Editar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal de confirmación simplificado -->
<div class="modal fade" id="confirmationModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
    aria-labelledby="confirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center" style="background-color: #f1f1f1;">
            <div class="modal-body d-flex flex-column align-items-center" style="height: 200px;">
                <h4 class="titulo m-0">EGRESO AGREGADO CORRECTAMENTE</h4>
                <a href="{% url 'egreso' %}" class="btn save mt-3">VOLVER</a>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block javascript %}
<script>
document.addEventListener("DOMContentLoaded", function() {
    const btnConfirmar = document.getElementById('btnConfirmar');
    const egresoForm = document.getElementById('egresoForm');
    const modal = new bootstrap.Modal(document.getElementById('confirmationModal'), {
        backdrop: 'static',  // Evita que el modal se cierre al hacer clic fuera
        keyboard: false      // Evita que el modal se cierre con la tecla ESC
    });
      
    btnConfirmar.addEventListener('click', function() {
        // Agregar un campo oculto para indicar la acción "confirmar"
        if (!document.querySelector('input[name="confirmar"]')) {
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'confirmar';
            hiddenInput.value = 'true';
            egresoForm.appendChild(hiddenInput);
        }
        
        // Obtener el token CSRF
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        // Crear FormData del formulario
        const formData = new FormData(egresoForm);
        
        // Enviar el formulario con Fetch API
        fetch(window.location.href, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrftoken
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Error en la respuesta del servidor');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Mostrar el modal
                modal.show();
                
                // Prevenir que el modal se cierre al hacer clic fuera
                document.querySelector('.modal-backdrop').addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            } else {
                console.error('Error al procesar el formulario:', data.message);
                alert('Ocurrió un error al procesar el egreso.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // Si hay un error, enviamos el formulario de manera tradicional como fallback
            egresoForm.submit();
        });
    });
    
    // Si se intenta cerrar el modal con Escape o haciendo clic fuera, prevenir
    document.querySelector('#confirmationModal').addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            e.preventDefault();
            e.stopPropagation();
        }
    });
});
</script>
{% endblock %}